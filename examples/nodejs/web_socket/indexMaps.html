<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <title>RTI Connector for Javascript Example - Maps</title>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.0.1/build/ol.js"></script>
    <style>
      .map {
        width: 100%;
        height:1000px;
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script>
      var socket = io.connect('http://127.0.0.1:7400')
      var latitude;
      var longitude;
      var color;
      var size;

      var Map = ol.Map;
      var View = ol.View;
      var TileLayer = ol.layer.Tile;
      var OSM = ol.source.OSM;
      var MultiPoint = ol.geom.MultiPoint;
      var Point = ol.geom.Point;
      var CircleStyle = ol.style.Circle;
      var Fill = ol.style.Fill;
      var Stroke = ol.style.Stroke;
      var Style = ol.style.Style;
      var getVectorContext = ol.render.getVectorContext;

      var vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector()
      });
      var map = new Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vectorLayer
        ],
        target: 'map',
        view: new View({
          center: [0, 0],
          zoom: 2
        })
      });

      var imageStyle = new Style({
        image: new CircleStyle({
          radius: 5,
          fill: new Fill({color: 'yellow'}),
          stroke: new Stroke({color: 'red', width: 1})
        })
      });

      var obtainMapShapeFromData = function (data) {
        var coordinates = [];
        // Convert y -> latitude
        latitude = -(data.y * (180/250) - 90);
        // Convert x -> longitude
        longitude = (data.x * (360/250) - 180);
        coordinates.push([longitude, latitude]);
        var receivedShape = new ol.Feature(
            new ol.geom.Point(ol.proj.fromLonLat(coordinates[0])));
        receivedShape.setStyle(new Style({
          image: new CircleStyle({
            radius: data.shapesize / 5,
            fill: new Fill({color: data.color}),
            stroke: new Stroke({color: 'black', width: 1})
          })
        }));
        return receivedShape;
      }

      var vectorSource = vectorLayer.getSource();
      var features = [];
      socket.on('shape', function (data) {
        while (features.length > 10) {
          vectorSource.removeFeature(features.shift())
        }
        features.push(obtainMapShapeFromData(data))
        vectorSource.addFeature(features[features.length - 1]);
      });

    </script>
  </body>
</html>
